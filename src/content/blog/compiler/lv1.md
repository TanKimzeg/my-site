---
title: Lv1ï¼šmainå‡½æ•° | ç¼–è¯‘åŸç†
description: "PKUç¼–è¯‘åŸç†å®è·µè¯¾ç¨‹"
pubDate: 2025 08 14
categories: 
  - tech
tags:
  - compiler
  - rust
---
æœ¬è¯¾ç¨‹çš„ç¼–è¯‘å¯¹è±¡ SysYè¯­è¨€æ˜¯ä¸€ç§ç®€å•ç‰ˆçš„Cè¯­è¨€.

ä½œä¸ºä¸€ç§ç¼–ç¨‹è¯­è¨€,å®ƒæœ‰å¦‚ä¸‹è§„èŒƒ:
1. è¯æ³•è§„èŒƒ
	- æ ‡è¯†ç¬¦`IDENT`
	- æ•°å€¼å¸¸é‡æ•´å‹æ•°`INT_CONST`
	- æ³¨é‡Š`// /* */`

2. è¯­æ³•è§„èŒƒ
	- å¼€å§‹ç¬¦å·ä¸º `CompUnit`
    
	 ```ebnf
	CompUnit ::= FuncDef;
	FuncDef ::= FuncType IDENT "()" Block;
	FuncType ::= "int";
	
	Block ::= "{}" Stmt;
	Stmt ::= "return" Number ";";
	Number ::= INT_CONST ;
	```

3. è¯­ä¹‰è§„èŒƒ
`INT_CONST`çš„èŒƒå›´ä¸º$[0,2^{31}-1]$, ä¸åŒ…å«è´Ÿå·.

å¯ä»¥çœ‹å‡º, SysYè¯­è¨€æ˜¯ç®€å•ç‰ˆçš„Cè¯­è¨€.

## ç¼–è¯‘å™¨çš„ç»“æ„
ç¼–è¯‘å™¨æŠŠæºä»£ç å˜æˆå¯æ‰§è¡Œæ–‡ä»¶çš„è¿‡ç¨‹:
1. ç¼–è¯‘: å°†æºä»£ç ç¼–è¯‘ä¸ºæ±‡ç¼–ä»£ç (assembly)
2. æ±‡ç¼–: å°†æ±‡ç¼–ä»£ç æ±‡ç¼–ä¸ºç›®æ ‡æ–‡ä»¶(obj file)
3. é“¾æ¥: å°†ç›®æ ‡æ–‡ä»¶é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶(executable)

æœ¬è¯¾ç¨‹ä¸­å®ç°çš„ç¼–è¯‘å™¨, åªæ¶‰åŠä¸Šè¿°ç¬¬ä¸€ç‚¹.å³å°†SysYæºä»£ç ç¼–è¯‘æˆRISC-Væ±‡ç¼–è¯­è¨€.åœ¨è¿™ç§æ„ä¹‰ä¹‹ä¸‹, ç¼–è¯‘å™¨é€šå¸¸ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆ:

- **å‰ç«¯:**Â é€šè¿‡è¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æ, å°†æºä»£ç è§£ææˆæŠ½è±¡è¯­æ³•æ ‘ (abstract syntax tree, AST). é€šè¿‡è¯­ä¹‰åˆ†æ, æ‰«ææŠ½è±¡è¯­æ³•æ ‘, æ£€æŸ¥å…¶æ˜¯å¦å­˜åœ¨è¯­ä¹‰é”™è¯¯.
- **ä¸­ç«¯:**Â å°†æŠ½è±¡è¯­æ³•æ ‘è½¬æ¢ä¸ºä¸­é—´è¡¨ç¤º (intermediate representation, IR), å¹¶åœ¨æ­¤åŸºç¡€ä¸Šå®Œæˆä¸€äº›æœºå™¨æ— å…³ä¼˜åŒ–.
- **åç«¯:**Â å°†ä¸­é—´è¡¨ç¤ºè½¬æ¢ä¸ºç›®æ ‡å¹³å°çš„æ±‡ç¼–ä»£ç , å¹¶åœ¨æ­¤åŸºç¡€ä¸Šå®Œæˆä¸€äº›æœºå™¨ç›¸å…³ä¼˜åŒ–.

### è¯æ³•åˆ†æé˜¶æ®µ
è¯æ³•åˆ†æçš„ä½œç”¨, æ˜¯æŠŠå­—èŠ‚æµè½¬æ¢ä¸ºå•è¯æµ (token stream). è¯æ³•åˆ†æå™¨ (lexer) ä¼šæŒ‰ç…§æŸç§è§„åˆ™è¯»å–æ–‡ä»¶, å¹¶å°†æ–‡ä»¶çš„å†…å®¹æ‹†åˆ†æˆä¸€ä¸ªä¸ª token ä½œä¸ºè¾“å‡º, ä¼ é€’ç»™è¯­æ³•åˆ†æå™¨ (parser). åŒæ—¶, lexer è¿˜ä¼šå¿½ç•¥æ–‡ä»¶é‡Œçš„ä¸€äº›æ— æ„ä¹‰çš„å†…å®¹, æ¯”å¦‚ç©ºæ ¼, æ¢è¡Œç¬¦å’Œæ³¨é‡Š.

è€Œè¯­æ³•åˆ†æçš„ç›®çš„, æŒ‰ç…§ç¨‹åºçš„è¯­æ³•è§„åˆ™, å°†è¾“å…¥çš„ token æµå˜æˆç¨‹åºçš„ AST.


### è¯­ä¹‰åˆ†æé˜¶æ®µ
è¯­ä¹‰åˆ†æé˜¶æ®µ, ç¼–è¯‘å™¨é€šå¸¸ä¼š:

- **å»ºç«‹ç¬¦å·è¡¨**, è·Ÿè¸ªç¨‹åºé‡Œå˜é‡çš„å£°æ˜å’Œä½¿ç”¨, ç¡®å®šç¨‹åºåœ¨æŸå¤„ç”¨åˆ°äº†å“ªä¸€ä¸ªå˜é‡, åŒæ—¶ä¹Ÿå¯å‘ç°å˜é‡é‡å¤å®šä¹‰/å¼•ç”¨æœªå®šä¹‰å˜é‡ä¹‹ç±»çš„é”™è¯¯.
- **è¿›è¡Œç±»å‹æ£€æŸ¥**, ç¡®å®šç¨‹åºä¸­æ˜¯å¦å­˜åœ¨è¯¸å¦‚ â€œå¯¹æ•´æ•°å˜é‡è¿›è¡Œæ•°ç»„è®¿é—®â€ è¿™ç§ç±»å‹é—®é¢˜. åŒæ—¶æ ‡æ³¨ç¨‹åºä¸­è¡¨è¾¾å¼çš„ç±»å‹, ä»¥ä¾¿è¿›è¡Œåç»­çš„ç”Ÿæˆå·¥ä½œ. å¯¹äºæŸäº›ç¼–ç¨‹è¯­è¨€ (ä¾‹å¦‚ C++11 ä¹‹åçš„ C++, Rust ç­‰ç­‰), ç¼–è¯‘å™¨è¿˜ä¼šè¿›è¡Œç±»å‹æ¨æ–­.
- **è¿›è¡Œå¿…è¦çš„ç¼–è¯‘æœŸè®¡ç®—**. SysY ä¸­æ”¯æŒä½¿ç”¨å¸¸é‡è¡¨è¾¾å¼ä½œä¸ºæ•°ç»„å®šä¹‰æ—¶çš„é•¿åº¦, è€Œæˆ‘ä»¬åœ¨ç”Ÿæˆ IR ä¹‹å‰, å¿…é¡»çŸ¥é“æ•°ç»„çš„é•¿åº¦ (SysY ä¸æ”¯æŒÂ [VLA](https://en.wikipedia.org/wiki/Variable-length_array)), è¿™å°±è¦æ±‚ç¼–è¯‘å™¨å¿…é¡»èƒ½åœ¨ç¼–è¯‘çš„æ—¶å€™ç®—å‡ºå¸¸é‡è¡¨è¾¾å¼çš„å€¼, åŒæ—¶å¯¹é‚£äº›æ— æ³•è®¡ç®—çš„å¸¸é‡è¡¨è¾¾å¼æŠ¥é”™. å¯¹äºæŸäº›æ”¯æŒå…ƒç¼–ç¨‹çš„è¯­è¨€, è¿™ä¸€æ­¥å¯èƒ½ä¼šéå¸¸å¤æ‚.

è‡³æ­¤, æˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸€ä¸ªè¯­æ³•æ­£ç¡®, è¯­ä¹‰æ¸…æ™°çš„ AST è¡¨ç¤ºäº†.

### IRç”Ÿæˆ
ç¼–è¯‘å™¨é€šå¸¸ä¼šå°† AST è½¬æ¢ä¸ºå¦ä¸€ç§å½¢å¼çš„æ•°æ®ç»“æ„, æˆ‘ä»¬æŠŠå®ƒç§°ä½œ IR. IR çš„æŠ½è±¡å±‚æ¬¡æ¯” AST æ›´ä½, ä½†åˆä¸è‡³äºä½åˆ°æ±‡ç¼–ä»£ç çš„ç¨‹åº¦. åœ¨æ­¤åŸºç¡€ä¸Š, æ— è®ºæ˜¯ç›´æ¥æŠŠ IR è¿›ä¸€æ­¥è½¬æ¢ä¸ºæ±‡ç¼–ä»£ç , è¿˜æ˜¯åœ¨ IR ä¹‹ä¸Šåšå‡ºä¸€äº›ä¼˜åŒ–, éƒ½ç›¸å¯¹æ›´å®¹æ˜“.

æœ‰äº† IR çš„å­˜åœ¨, æˆ‘ä»¬ä¹Ÿå¯ä»¥å¤§å¹…é™ä½ç¼–è¯‘å™¨çš„å¼€å‘æˆæœ¬: å‡è®¾æˆ‘ä»¬æƒ³å¼€å‘Â MMÂ ç§è¯­è¨€çš„ç¼–è¯‘å™¨, è¦æ±‚å®ƒä»¬èƒ½æŠŠè¾“å…¥ç¼–è¯‘æˆÂ NNÂ ç§æŒ‡ä»¤ç³»ç»Ÿçš„ç›®æ ‡ä»£ç , åœ¨æ²¡æœ‰ç»Ÿä¸€çš„ IR çš„æƒ…å†µä¸‹, æˆ‘ä»¬éœ€è¦å¼€å‘Â MÃ—NMÃ—NÂ ä¸ªç›¸å…³æ¨¡å—. å¦‚æœæˆ‘ä»¬å…ˆæŠŠæ‰€æœ‰æºè¯­è¨€éƒ½è½¬æ¢åˆ°åŒä¸€ç§ IR, ç„¶åå†å°†è¿™ç§ IR ç¿»è¯‘ä¸ºä¸åŒçš„ç›®æ ‡ä»£ç , æˆ‘ä»¬å°±åªéœ€è¦å¼€å‘Â M+NM+NÂ ä¸ªç›¸å…³æ¨¡å—.

### ç›®æ ‡ä»£ç ç”Ÿæˆ

ç¼–è¯‘å™¨è¿›è¡Œçš„æœ€åä¸€æ­¥æ“ä½œ, å°±æ˜¯å°† IR è½¬æ¢ä¸ºç›®æ ‡ä»£ç , ä¹Ÿå°±æ˜¯ç›®æ ‡æŒ‡ä»¤ç³»ç»Ÿçš„æ±‡ç¼–ä»£ç . é€šå¸¸æƒ…å†µä¸‹, è¿™ä¸€æ­¥é€šå¸¸è¦åšä»¥ä¸‹å‡ ä»¶äº‹:

1. **æŒ‡ä»¤é€‰æ‹©:**Â å†³å®š IR ä¸­çš„æŒ‡ä»¤åº”è¯¥è¢«ç¿»è¯‘ä¸ºå“ªäº›ç›®æ ‡æŒ‡ä»¤ç³»ç»Ÿçš„æŒ‡ä»¤. ä¾‹å¦‚å‰æ–‡çš„ Koopa IR ç¨‹åºä¸­å‡ºç°çš„Â `lt`Â æŒ‡ä»¤å¯ä»¥è¢«ç¿»è¯‘ä¸º RISC-V ä¸­çš„Â `slt`/`slti`Â æŒ‡ä»¤.
2. **å¯„å­˜å™¨åˆ†é…:**Â å†³å®š IR ä¸­çš„å€¼å’ŒæŒ‡ä»¤ç³»ç»Ÿä¸­å¯„å­˜å™¨çš„å¯¹åº”å…³ç³». ä¾‹å¦‚å‰æ–‡çš„ Koopa IR ç¨‹åºä¸­çš„Â `@x`,Â `%cond`,Â `%0`Â ç­‰ç­‰, å®ƒä»¬æœ€ç»ˆå¯èƒ½ä¼šè¢«æ”¾åœ¨ RISC-V çš„æŸäº›å¯„å­˜å™¨ä¸­. ç”±äºæŒ‡ä»¤ç³»ç»Ÿä¸­å¯„å­˜å™¨çš„æ•°é‡é€šå¸¸æ˜¯æœ‰é™çš„ (RISC-V ä¸­åªæœ‰ 32 ä¸ªæ•´æ•°é€šç”¨å¯„å­˜å™¨, ä¸”å®ƒä»¬å¹¶ä¸éƒ½èƒ½ç”¨æ¥å­˜æ”¾æ•°æ®), æŸäº›å€¼è¿˜å¯èƒ½ä¼šè¢«åˆ†é…åœ¨å†…å­˜ä¸­.
3. **æŒ‡ä»¤è°ƒåº¦:**Â å†³å®š IR ç”Ÿæˆçš„æŒ‡ä»¤åºåˆ—æœ€ç»ˆçš„é¡ºåºå¦‚ä½•. æˆ‘ä»¬é€šå¸¸å¸Œæœ›ç¼–è¯‘å™¨èƒ½ç”Ÿæˆä¸€ä¸ªæœ€ä¼˜åŒ–çš„æŒ‡ä»¤åºåˆ—, å®ƒå¯ä»¥æœ€å¤§ç¨‹åº¦åœ°åˆ©ç”¨ç›®æ ‡å¹³å°çš„å¾®ç»“æ„ç‰¹æ€§, è¿™æ ·ç”Ÿæˆçš„ç¨‹åºçš„æ€§èƒ½å°±ä¼šå¾ˆé«˜. ä¾‹å¦‚ç¼–è¯‘å™¨å¯èƒ½ä¼šç©¿æ’è°ƒåº¦è®¿å­˜æŒ‡ä»¤å’Œå…¶ä»–æŒ‡ä»¤, ä»¥æ±‚å‡å°‘è®¿å­˜å¯¼è‡´çš„åœé¡¿.


## è¯æ³•/è¯­æ³•åˆ†æåˆè§
EBNF ä¸­è¿˜ä¼šå‡ºç°ä¸€äº›åˆ«çš„è®°æ³•:

- `A | B`Â è¡¨ç¤ºå¯ä»¥æ¨å¯¼å‡ºÂ `A`, æˆ–è€…Â `B`.
- `[...]`Â è¡¨ç¤ºæ–¹æ‹¬å·å†…åŒ…å«çš„é¡¹å¯è¢«é‡å¤ 0 æ¬¡æˆ– 1 æ¬¡.
- `{...}`Â è¡¨ç¤ºèŠ±æ‹¬å·å†…åŒ…å«çš„é¡¹å¯è¢«é‡å¤ 0 æ¬¡æˆ–å¤šæ¬¡.

åœ¨Rustä¸­, lalrpopæ¥å¸®åŠ©ç”Ÿæˆè¯æ³•/è¯­æ³•åˆ†æå™¨. lalrpopæ˜¯ä¸€ä¸ªLR/LALRåˆ†æå™¨ç”Ÿæˆå™¨.

ä¸ºäº†ä½¿ç”¨lalrpop, æˆ‘è¿è¡Œäº†
```shell
cargo add lalrpop --features=lexer
```
å—æ³¨é‡Š(/\* \*/)çš„æ­£åˆ™è¡¨è¾¾å¼: `\/\*[^\/]*\*\/`

é˜…è¯»äº†ä¸€ä¸‹æ•™ç¨‹çš„ä»£ç , åœ¨è™šæ‹Ÿæœºä¸­è¿è¡Œäº†ä¸€ä¸‹, å‘ç°æŠ¥é”™Rustç‰ˆæœ¬ä¸åŒ¹é….æ‰€ä»¥`cargo init`åº”åœ¨è™šæ‹Ÿæœºé‡Œé¢æ‰§è¡Œ.æŠŠ`edition`æ”¹ä¸º2021,`version`æ”¹ä¸º3åæ¢å¤äº†æ­£å¸¸.ç¼–è¯‘æ—¶é—´æ¯”è¾ƒä¹…,ç„¶åå°±å¯ä»¥çœ‹åˆ°è¾“å‡ºäº†.

## è§£æ`main`å‡½æ•°
ä¸Šä¸€èŠ‚æˆ‘ä»¬å€ŸåŠ©è¯æ³•/è¯­æ³•åˆ†æå™¨è§£æäº†`main`å‡½æ•°,ä½†æ˜¯åªèƒ½æŠŠè¾“å…¥çš„æºä»£ç è½¬æ¢æˆ, å‘ƒ, æºä»£ç , è€Œä¸æ˜¯ AST.

### è®¾è®¡AST
æˆ‘åœ¨src/ä¸‹é¢åˆ›å»ºäº† `ast.rs`, é‡Œé¢æ”¾ç½®äº†ä¸€äº›ç»“æ„ä½“, ç„¶ååˆ›å»º `lib.rs`æš´éœ² `ast.rs`

é‡è¦çš„æ˜¯åœ¨ `sysy.lalrpop`é‡Œé¢ä½¿ç”¨è¿™äº›æ–°ç»“æ„ä½“,ä¸€å®šè¦åœ¨ç¬¬ä¸€è¡Œå‰é¢åŠ ä¸Š
`use compiler::ast::*;`
æ•™ç¨‹æ²¡æœ‰æè¿™è¡ŒåŠ åœ¨å“ªé‡Œ,æˆ‘è¯•äº†å¾ˆå¤šåœ°æ–¹ğŸ˜­,ç¬¬äºŒè¡Œä¹Ÿä¸è¡Œ,

> ä¸å¾—ä¸è¯´ç¼–è¯‘å¥½æ…¢å•Š

è¿™æ ·æˆ‘ä»¬å¾—åˆ°äº†AST: 
```
CompUnit {
    func_def: FuncDef {
        func_type: Int,
        id: "main",
        block: Block {
            stmt: Stmt {
                num: 3,
            },
        },
    },
}
```
å¾ˆå¥½!

## Lv1.4 IRç”Ÿæˆ
æˆ‘ä»¬å·²ç»æœ‰äº†AST,ç°åœ¨è¦å˜æˆKoopa IR

### è¯­ä¹‰åˆ†æ
> åœ¨è¯¾ç¨‹å®è·µä¸­, æ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹å‡ä¸ºç¬¦åˆè¯­æ³•/è¯­ä¹‰è§„èŒƒçš„ SysY ç¨‹åº.Â **æˆ‘ä»¬ä¸è¦æ±‚ä½ ç¼–å†™çš„ç¼–è¯‘å™¨å…·å¤‡å¤„ç†è¯­æ³•/è¯­ä¹‰é”™è¯¯çš„èƒ½åŠ›, ä¹Ÿä¸ä¼šè€ƒå¯Ÿè¿™äº›å†…å®¹.**Â ä½†æˆ‘ä»¬å¸Œæœ›å­¦æœ‰ä½™åŠ›çš„åŒå­¦, èƒ½å¤Ÿåœ¨è‡ªå·±çš„ç¼–è¯‘å™¨ä¸­æ£€æŸ¥è¿™äº›é—®é¢˜, å¹¶å¯¹å…¶ä½œå‡ºåˆé€‚çš„å¤„ç†, æ¯”å¦‚åƒÂ `clang`Â æˆ–Â `rustc`Â ä¸€æ ·, ç»™å‡ºç²¾ç¡®åˆ°è¡Œåˆ—çš„é”™è¯¯ä¿¡æ¯, ç”šè‡³å…·å¤‡å¿½ç•¥é”™è¯¯ç»§ç»­æ‰«æ, ä»¥åŠå¯¹é”™è¯¯ç»™å‡ºä¿®æ”¹å»ºè®®çš„é«˜çº§åŠŸèƒ½.

ğŸ¤”

### Koopa IRåŸºç¡€
æœ¬ç« ä¸­æˆ‘ä»¬åªä¼šç”¨åˆ°å‡½æ•°è¿”å›æŒ‡ä»¤å’Œæ•´æ•°å¸¸é‡, ä¹Ÿå°±æ˜¯Â `Return`Â å’ŒÂ `Integer`.

è¿™ä¸ªç¨‹åºå†™å‡ºæ¥é•¿è¿™æ ·:

```
fun @main(): i32 {  // main å‡½æ•°çš„å®šä¹‰
%entry:             // å…¥å£åŸºæœ¬å—
  ret 0             // return 0
}
```

### ç”ŸæˆKoopa IR
ä¸ºäº†ç”Ÿæˆå­—ç¬¦ä¸²å½¢å¼çš„ `Koopa IR`, æˆ‘å†³å®šè°ƒç”¨`Koopa IR`æ¡†æ¶æä¾›çš„æ¥å£.

> è¿™çœŸæ˜¯æŒæ¡Rustçš„å­¦ç”Ÿçš„ç¦åˆ©!æœ‰æ¥å£å½“ç„¶æ˜¯ä½¿ç”¨æ¥å£äº†,çœå»äº†ä¸€å¤§å †æ–‡æœ¬å­—ç¬¦ä¸²å¤„ç†.


ç ”ç©¶äº†ä¸€ç•ª[Koopa IRæ–‡æ¡£](https://docs.rs/koopa/latest/koopa/ir/index.html)å, æˆ‘å†™å‡ºäº†é’ˆå¯¹æœ¬ç« è¦æ±‚çš„AST -> Koopa IRè½¬æ¢.

åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œæµ‹è¯•:
```shell
autotest -koopa -s lv1 /root/compiler
```

ç»ˆç«¯å¦‚ä¸‹è¾“å‡º:
```
    Finished release [optimized] target(s) in 17.95s
running test "0_main" ... PASSED
running test "1_comments" ... PASSED
running test "2_int_dec" ... PASSED
running test "3_int_oct" ... PASSED
running test "4_int_hex" ... PASSED
running test "5_compact" ... PASSED
running test "6_whitespaces" ... PASSED
PASSED (7/7)
```

é€šè¿‡äº†!

