---
title: 第三部分 高级知识拓展 | Hello-Agents
description: Hello-Agents第三部分 高级知识拓展.包含五个章节:记忆与检索、上下文工程、智能体通信协议、Agentic-RL、智能体性能评估.
pubDate: 2025 11 16 
categories: 
  - tech
tags:
  - llm
  - agent
---

## 记忆与检索

在上一章构建的框架基础上，为HelloAgents增加两个核心能力：**记忆系统（Memory System）**和**检索增强生成（Retrieval-Augmented Generation, RAG）**。

### 记忆系统

HelloAgents受人类记忆启发,设计了四层记忆系统:

首先是**工作记忆 (Working Memory)**，它扮演着智能体“短期记忆”的角色，主要用于存储当前对话的上下文信息。为确保高速访问和响应，其容量被有意限制（例如，默认50条），并且生命周期与单个会话绑定，会话结束后便会自动清理。

其次是**情景记忆 (Episodic Memory)**，它负责长期存储具体的交互事件和智能体的学习经历。与工作记忆不同，情景记忆包含了丰富的上下文信息，并支持按时间序列或主题进行回顾式检索，是智能体“复盘”和学习过往经验的基础。

与具体事件相对应的是**语义记忆 (Semantic Memory)**，它存储的是更为抽象的知识、概念和规则。例如，通过对话了解到的用户偏好、需要长期遵守的指令或领域知识点，都适合存放在这里。这部分记忆具有高度的持久性和重要性，是智能体形成“知识体系”和进行关联推理的核心。

最后，为了与日益丰富的多媒体交互，我们引入了**感知记忆 (Perceptual Memory)**。该模块专门处理图像、音频等多模态信息，并支持跨模态检索。其生命周期会根据信息的重要性和可用存储空间进行动态管理。

`xxMemory`类都有 `add` 和 `retrive` 两个方法,其实我觉得可以先用`ABC`定义一个抽象接口,在分别实现具体的记忆.

#### 工作记忆

工作记忆采用了纯内存存储方案，配合TTL（Time To Live）机制进行自动清理。

使用TF-IDF向量化进行语义检索，如果失败则回退到关键词匹配。这种设计确保了在各种环境下都能提供可靠的检索服务。评分算法结合了语义相似度、时间衰减和重要性权重，最终得分公式为：`(相似度 × 时间衰减) × (0.8 + 重要性 × 0.4)`。

#### 情景记忆

情景记忆采用了SQLite+Qdrant的混合存储方案，SQLite负责结构化数据的存储和复杂查询，Qdrant负责高效的向量检索。

#### 语义记忆

语义记忆采用了Neo4j图数据库和Qdrant向量数据库的混合架构，这种设计让系统既能进行快速的语义检索，又能利用知识图谱进行复杂的关系推理。

语义记忆的检索实现了混合搜索策略，结合了向量检索的语义理解能力和图检索的关系推理能力

#### 感知记忆

感知记忆支持文本、图像、音频等多种模态的数据存储和检索。它采用了模态分离的存储策略，为不同模态的数据创建独立的向量集合.

同模态检索利用专业的编码器进行精确匹配，而跨模态检索则需要更复杂的语义对齐机制.

### RAG系统: 知识检索增强

RAG系统的原理不再赘述.可以查看前面的all-in-rag文章.

这里要提一下查询重写策略

#### 高级检索策略

##### 多查询扩展(MQE)

通过调用LLM(或者预先写好的)生成多样化查询来提高检索召回率技术.
例如，"如何学习Python"可以扩展为"Python入门教程"、"Python学习方法"、"Python编程指南"等多个查询。

MQE的优势在于它能够自动理解用户查询的多种可能含义，特别是对于模糊查询或专业术语查询效果显著。

##### 假设文档嵌入(HyDE)

它的核心思想是用答案找答案.传统的检索方法是用问题去匹配文档，但问题和答案在语义空间中的分布往往存在差异——问题通常是疑问句，而文档内容是陈述句。HyDE通过让LLM先生成一个假设性的答案段落，然后用这个答案段落去检索真实文档，从而缩小了查询和文档之间的语义鸿沟。

即使假设答案的内容不完全正确，它所包含的关键术语、概念和表述风格也能有效引导检索系统找到正确的文档。特别是对于专业领域的查询，HyDE能够生成包含领域术语的假设文档，显著提升检索精度.

##### 扩展检索框架

HelloAgents将MQE和HyDE两种策略整合到统一的扩展检索框架中。系统通过`enable_mqe`和`enable_hyde`参数让用户可以根据具体场景选择启用哪些策略：对于需要高召回率的场景可以同时启用两种策略，对于性能敏感的场景可以只使用基础检索。

扩展检索的核心机制是"扩展-检索-合并"三步流程。首先，系统根据原始查询生成多个扩展查询（包括MQE生成的多样化查询和HyDE生成的假设文档）；然后，对每个扩展查询并行执行向量检索，获取候选文档池；最后，通过去重和分数排序合并所有结果，返回最相关的top-k文档。

### 构建智能文档问答助手

我觉得记忆系统的亮点在于个性化的学习支持.记忆整合和选择性遗忘,让智能体越用越聪明.

在什么情况下应该优先使用RAG？在什么情况下应该优先使用Memory？如何设计一个"智能路由"机制来自动选择最合适的检索方式？

用neo4j的知识图谱构建解题思维导图,能否带来显著的性能提升?

## 上下文工程

仅有记忆与检索还不够——我们需要一套工程化方法，持续、系统地为模型构造恰当的“上下文”。这就是本章的主题：上下文工程（Context Engineering）。它关注的是“在每一次模型调用前，如何以可复用、可度量、可演进的方式，拼装并优化输入上下文”，从而提升正确性、鲁棒性与效率。

### 什么是上下文工程

我们都听说过提示词工程。但近年来 **上下文工程** 越来越受到重视。什么样的上下文配置，最有可能让模型产出我们期望的行为？

[Prompt engineering vs Context engineering](https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/9-figures/9-1.webp)

一个循环运行的智能体，会不断产生下一轮推理可能相关的数据，这些信息必须被**周期性地提炼**。因此，上下文工程的“艺与术”，在于从持续扩张的“候选信息宇宙”中，**甄别哪些内容应当进入有限的上下文窗口**。

### 为什么上下文工程重要

模型的上下文窗口是固定的。随着tokens增加，模型从上下文中准确回忆信息的能力下降。因此，上下文必须被视为一种有限资源，就像人类有限的工作记忆容量一样。

基于上述现实，**有意识的上下文工程**就成为构建强健智能体的必需品。

### ContextBuilder实践

典型的[建造者设计模式](https://blog.csdn.net/u012723673/article/details/154790346)

第七章第一次看Hello Agents的代码就感到一股Java味，到这里彻底破案了🤭

### NoteTool: 结构化笔记

- [ ] 待补充

### TerminalTool: 即时文件系统访问

- [ ] 待补充

### 长程智能体实战

## 智能体通信协议

智能体在实际中面临三种交互需求：

1. 智能体与工具的通信。为此引入**MCP(Model Context Protocol)**
2. 智能体间的点对点协作。为此引入了**A2A(Agent-to-Agent Protocol)**
3. 大规模智能体网络。为此引入了**ANP(Agent Network Protocol)**

### 智能体通信协议基础

有了通信协议，**标准化接口**让不同服务提供统一的访问方式，**互操作性**使得不同开发者的工具可以无缝集成，**动态发现**允许智能体在运行时发现新的服务和能力，**可扩展性**让系统能够轻松添加新的功能模块。

#### 三种协议设计理念比较

[三种协议对比](https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-1.png)

#### MCP传输方式

[MCP传输方式对比](https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-4.png)

### MCP协议

MCP 协议采用 Host、Client、Servers 三层架构设计。这种架构设计的优势在于**关注点分离**：Host 专注于用户体验，Client 专注于协议通信，Server 专注于具体功能实现。开发者只需专注于开发对应的 MCP Server，无需关心 Host 和 Client 的实现细节。

[MCP核心能力](https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-2.png)

这三种能力的区别在于：**Tools 是主动的**（执行操作），**Resources 是被动的**（提供数据），**Prompts 是指导性的**（提供模板）。

MCP的工作流程：

[MCP工作流程](https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-6.png)

MCP与Function Call的差异：

[MCP与Function Call的差异](https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-3.png)

> Function Call 我还不太理解...

MCP 协议的一个重要特性是**传输层无关性**（Transport Agnostic）。这意味着 MCP 协议本身不依赖于特定的传输方式，可以在不同的通信通道上运行。

### A2A协议

MCP 协议解决了智能体与工具的交互，而 A2A 协议则解决智能体之间的协作问题。

A2A 请求生命周期是一个序列，详细说明了请求遵循的四个主要步骤：代理发现、身份验证、发送消息 API 和发送消息流 API。

### ANP协议

ANP 协议则专注于解决大规模、开放网络环境下的智能体管理问题。

当一个网络中存在大量功能各异的智能体（例如，自然语言处理、图像识别、数据分析等）时，系统会面临一系列挑战：

- **服务发现**：当新任务到达时，如何快速找到能够处理该任务的智能体？
- **智能路由**：如果多个智能体都能处理同一任务，如何选择最合适的一个（如根据负载、成本等）并向其分派任务？
- **动态扩展**：如何让新加入网络的智能体被其他成员发现和调用？

ANP 的设计目标就是提供一套标准化的机制，来解决上述的服务发现、路由选择和网络扩展性问题。

[ANP核心概念](https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-8.png)

在这个流程图里，主要包括以下几个步骤：

**1. 服务的发现与匹配：**首先，智能体 A 通过一个公开的发现服务，基于语义或功能描述进行查询，以定位到符合其任务需求的智能体 B。该发现服务通过预先爬取各智能体对外暴露的标准端点（`.well-known/agent-descriptions`）来建立索引，从而实现服务需求方与提供方的动态匹配。

**2. 基于 DID 的身份验证：**在交互开始时，智能体 A 使用其私钥对包含自身 DID 的请求进行签名。智能体 B 收到后，通过解析该 DID 获取对应的公钥，并以此验证签名的真实性与请求的完整性，从而建立起双方的可信通信。

**3. 标准化的服务执行：**身份验证通过后，智能体 B 响应请求，双方依据预定义的标准接口和数据格式进行数据交换或服务调用（如预订、查询等）。标准化的交互流程是实现跨平台、跨系统互操作性的基础。

总而言之，该机制的核心是利用 DID 构建了一个去中心化的信任根基，并借助标准化的描述协议实现了服务的动态发现。这套方法使得智能体能够在无需中央协调的前提下，安全、高效地在互联网上形成协作网络。

## Agentic-RL

- [ ] 待补充

## 智能体性能评估

- [ ] 待补充

## 习题

1. 本章介绍了三种智能体通信协议：MCP、A2A 和 ANP。请分析：

    - 在 10.1.2 节中对比了三种协议的设计理念。请深入分析：为什么 MCP 强调"上下文共享"，A2A 强调"对话式协作"，而 ANP 强调"网络拓扑"？这些设计理念分别解决了什么核心问题？

> MCP 协议解决了智能体与工具的交互，而 A2A 协议则解决智能体之间的协作问题。ANP 协议则专注于解决大规模、开放网络环境下的智能体管理问题。
    - 假设你要构建一个"智能客服系统"，需要以下功能：（1）访问客户数据库和订单系统；（2）多个专业客服智能体协作处理复杂问题；（3）支持大规模并发用户请求。请为每个功能选择最合适的协议，并说明理由。
> (1) MCP,需要使用数据库访问等工具 (2) A2A，智能体都属于客服，可以形成工作流 (3) ANP.需要设置路由，按功能分类
    - 三种协议是否可以组合使用？请设计一个实际应用场景，展示如何同时使用 MCP、A2A 和 ANP 来构建一个完整的智能体系统。画出系统架构图并说明各协议的职责。
> 可以组合使用

2. MCP（Model Context Protocol）是智能体与工具通信的标准协议。基于 10.2 节的内容，请深入思考：

    - 在 10.2.3 节的 MCP 服务器实现中，我们定义了`list_tools`、`call_tool`等核心方法。请扩展这个实现，添加一个新的 MCP 服务器，提供以下工具：（1）数据库查询工具；（2）数据可视化工具；（3）报表生成工具。要求工具之间能够协作完成复杂的数据分析任务。

> 可以在数据库MCP服务器的基础上增加工具函数。
    - MCP 协议支持"资源"（Resources）和"提示"（Prompts）两个重要概念，但本章主要聚焦于"工具"（Tools）。请查阅 MCP 官方文档，了解 Resources 和 Prompts 的设计目的，并设计一个应用场景，展示如何利用这三个核心概念构建更强大的智能体系统。
    - MCP 使用 JSON-RPC 2.0 作为底层通信协议，通过 stdio 进行进程间通信。请分析：这种设计有什么优势和局限性？如果需要支持远程 MCP 服务器（通过 HTTP/WebSocket 访问），应该如何扩展当前的实现？
> JSON结构规整，可读性强，压缩率也还可以。stdio延迟较低。但没有加密。对于加密需求，需依赖网络协议（如HTTPS）。将MCP协议建立在应用层HTTP/HTTPS上。
